<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://bofengsun.github.io/</id>
    <title>ç©å‘½æœ‰äººç–¼</title>
    <updated>2019-12-25T06:49:47.351Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://bofengsun.github.io/"/>
    <link rel="self" href="https://bofengsun.github.io//atom.xml"/>
    <subtitle>é‡æ–°å¼€å§‹ï¼Œä»å¿ƒå¼€å§‹ï¼</subtitle>
    <logo>https://bofengsun.github.io//images/avatar.png</logo>
    <icon>https://bofengsun.github.io//favicon.ico</icon>
    <rights>All rights reserved 2019, ç©å‘½æœ‰äººç–¼</rights>
    <entry>
        <title type="html"><![CDATA[ä¸ä½ ç›¸é‡æ°ä¼¼é‚£ä¸€åœºæ¢¦]]></title>
        <id>https://bofengsun.github.io//post/yu-ni-xiang-yu-qia-si-na-yi-chang-meng</id>
        <link href="https://bofengsun.github.io//post/yu-ni-xiang-yu-qia-si-na-yi-chang-meng">
        </link>
        <updated>2019-12-25T06:30:19.000Z</updated>
        <summary type="html"><![CDATA[<p>æˆ‘èµ°åœ¨ä¹¡é—´çš„å°è·¯<br>
æƒ³èµ·äº†å¾€äº‹ç¯‡ç¯‡<br>
ä½ çœ‹</p>
]]></summary>
        <content type="html"><![CDATA[<p>æˆ‘èµ°åœ¨ä¹¡é—´çš„å°è·¯<br>
æƒ³èµ·äº†å¾€äº‹ç¯‡ç¯‡<br>
ä½ çœ‹</p>
<!-- more -->
<p>å¤å¤©ï¼ŒèŠ±ä¸›ï¼Œå°é“<br>
èæ°´ç›¸é€¢ï¼Œä½ çš„ç¬‘å®¹ï¼Œä¾¿æ°¸é©»æˆ‘å¿ƒé—´</p>
<p>æˆ‘ä»¬ä¸€è·¯èµ°æ¥<br>
çˆ±ä½¿ä½ æˆ‘ç›¸é‡ç›¸çŸ¥ç›¸æ€ç›¸å®ˆ<br>
ä½ æˆ‘åœ¨ä¸€èµ·çš„ä¸¤åƒå¤šä¸ªæ—¥å­<br>
å¤å†¬ä¸æ˜¥ç§‹ï¼Œåœ°åŒ—ä¸å¤©å—<br>
èè¸ªé¡å®šï¼Œæˆ‘çš„å¿ƒï¼Œæ°¸åœ¨ä½ èº«è¾¹</p>
<p>é‚£å¤œï¼Œæ¢¦åˆ°ä½ å‡ºå«<br>
ä¸€æ€èµ·ç›–å¤´ï¼Œæˆ‘å‚»å‚»åœ°çœ‹ä½ ï¼Œä½ å¨‡ç¾åœ°çœ‹æˆ‘<br>
åœºé¢çƒ­é—¹ï¼Œè¡—åŠé‚»é‡Œï¼Œæ‹æ‰‹å«å¥½<br>
æ¢¦é†’ï¼Œåƒé‡Œç›¸æ€ï¼Œæƒ³å¯¹ä½ è¯´ï¼Œå«æˆ‘å¥½å—ï¼Ÿ</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Spring Beanç”Ÿå‘½å‘¨æœŸ]]></title>
        <id>https://bofengsun.github.io//post/spring-bean-sheng-ming-zhou-qi</id>
        <link href="https://bofengsun.github.io//post/spring-bean-sheng-ming-zhou-qi">
        </link>
        <updated>2019-12-25T01:19:55.000Z</updated>
        <summary type="html"><![CDATA[<p>Spring Boot Beançš„ç”Ÿå‘½å‘¨æœŸï¼Œä»€ä¹ˆæ˜¯Beançš„ç”Ÿå‘½å‘¨æœŸï¼Œå°±æ˜¯Beanä»åˆ›å»ºåˆ°é”€æ¯çš„è¿‡ç¨‹ã€‚ä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸€çœ‹SpringBeançš„ç”Ÿå‘½å†ç¨‹å§ï¼</p>
]]></summary>
        <content type="html"><![CDATA[<p>Spring Boot Beançš„ç”Ÿå‘½å‘¨æœŸï¼Œä»€ä¹ˆæ˜¯Beançš„ç”Ÿå‘½å‘¨æœŸï¼Œå°±æ˜¯Beanä»åˆ›å»ºåˆ°é”€æ¯çš„è¿‡ç¨‹ã€‚ä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸€çœ‹SpringBeançš„ç”Ÿå‘½å†ç¨‹å§ï¼</p>
<!-- more -->
<h1 id="beançš„ç”Ÿå‘½å‘¨æœŸè¿‡ç¨‹æè¿°">Beançš„ç”Ÿå‘½å‘¨æœŸè¿‡ç¨‹æè¿°</h1>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹Beançš„ç”Ÿå‘½å‘¨æœŸè¿‡ç¨‹ä¸­éƒ½ä¼šç»å†äº›ä»€ä¹ˆï¼Œæˆ‘å…ˆç®€å•è§£é‡Šä¸€ä¸‹ï¼Œåé¢æˆ‘ä»¬é€šè¿‡æºç è¿›è¡Œè¯¦ç»†è§£é‡Šã€‚é¦–å…ˆSpringåœ¨å®ä¾‹åŒ–Beançš„æ—¶å€™ï¼Œä¼šå…ˆè°ƒç”¨å®ƒçš„æ„é€ å‡½æ•°ï¼Œè¿›è¡ŒBeançš„å®ä¾‹åŒ–ï¼Œç„¶åè¿›è¡ŒBeançš„åˆå§‹åŒ–ï¼ŒBeançš„åˆå§‹åŒ–ç»è¿‡ä¸‰ä¸ªé˜¶æ®µåˆå§‹åŒ–ä¹‹å‰ï¼ˆ<strong>applyBeanPostProcessorsBeforeInitialization</strong>ï¼‰ï¼Œå…¶æ¬¡æ˜¯è¿›è¡Œåˆå§‹åŒ–ï¼ˆ<strong>invokeInitMethods</strong>ï¼‰ï¼Œæœ€åæ˜¯åˆå§‹åŒ–ä¹‹åï¼ˆ<strong>postProcessAfterInitialization</strong>ï¼‰ï¼Œè¿™å°±æ˜¯Beançš„åˆå§‹åŒ–è¿‡ç¨‹ï¼›ç„¶åå°±å¼€å§‹åˆ©ç”¨Beanè¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæœ€åå®¹å™¨æ­£å¸¸å…³é—­ï¼ŒSpringå¼€å§‹é”€æ¯Beanï¼ŒBeançš„é”€æ¯è¿‡ç¨‹ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œè°ƒç”¨**DisposableBeanAdapter.destroy()**æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­æœ‰ä¸‰ä¸ªåœ°æ–¹æ¯”è¾ƒé‡è¦ï¼Œåˆ†åˆ«è§¦å‘Beançš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå®ƒä»¬æ˜¯ï¼š<strong>processor.postProcessBeforeDestruction(this.bean, this.beanName);<br>
((DisposableBean) bean).destroy();<br>
invokeCustomDestroyMethod(this.destroyMethod);</strong><br>
ä¸‹é¢æˆ‘æŠŠç”¨å›¾ç‰‡æ¥è¿›è¡Œç›´è§‚å±•ç¤ºï¼š<br>
<img src="https://bofengsun.github.io//post-images/1577242534383.png" alt="Beançš„ç”Ÿå‘½å‘¨æœŸ.png"></p>
<h1 id="å®ä¾‹è¿è¡Œ">å®ä¾‹è¿è¡Œ</h1>
<p>Userç±»ï¼Œè¿™é‡Œå°±æ˜¯æ™®é€šçš„ä¸€ä¸ªBean,ç”¨æ¥æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œè§‚å¯Ÿå…¶ç”Ÿå‘½å‘¨æœŸ</p>
<pre><code>package com.itbofeng.bean;
import org.springframework.beans.factory.DisposableBean;
import org.springframework.beans.factory.InitializingBean;
import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;
public class User implements InitializingBean , DisposableBean {
    private String name;
    public User() {
        System.out.println(&quot;è°ƒç”¨Beançš„å‡½æ•°(constructor)&quot;);
    }
    public String getName() {
        return name;
    }
    public void setName(String name) {
        System.out.println(&quot;è°ƒç”¨Beançš„å‡½æ•°(setName/setAttribute)&quot;);
        this.name = name;
    }
    @PostConstruct
    public void postConstruct(){
        System.out.println(&quot;è°ƒç”¨Beançš„å‡½æ•°(postConstruct)&quot;);
    }
    //MainConfigä¸­@Bean çš„initMethod
    public void initMethod(){
        System.out.println(&quot;è°ƒç”¨Beançš„å‡½æ•°(initMethod)&quot;);
    }
    //InitializingBeanæ¥å£çš„æ–¹æ³•afterPropertiesSet
    @Override
    public void afterPropertiesSet() throws Exception {
        System.out.println(&quot;è°ƒç”¨Beançš„å‡½æ•°(afterPropertiesSet)&quot;);
    }
    @PreDestroy
    public void preDestroy(){
        System.out.println(&quot;è°ƒç”¨Beançš„å‡½æ•°(preDestroy)&quot;);
    }
    //DisposableBeanæ¥å£çš„æ–¹æ³•destroy
    @Override
    public void destroy() throws Exception {
        System.out.println(&quot;è°ƒç”¨Beançš„å‡½æ•°(destroy)&quot;);
    }
    //MainConfigä¸­@Bean çš„destroyMethod
    public void destroyMethod(){
        System.out.println(&quot;è°ƒç”¨Beançš„å‡½æ•°(destroyMethod)&quot;);
    }
}
</code></pre>
<p>CustomBeanPostProcessorç±»ï¼Œç”¨æ¥è§‚å¯ŸBeanPostProcessorçš„è¿è¡Œæ—¶æœŸ</p>
<pre><code>package com.itbofeng.bean;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.config.BeanPostProcessor;
import org.springframework.lang.Nullable;
import org.springframework.stereotype.Component;
@Component
public class CustomBeanPostProcessor implements BeanPostProcessor {
    @Nullable
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if(bean.getClass()==User.class){
            System.out.println(&quot;è°ƒç”¨postProcessBeforeInitialization...&quot;);
        }
        return bean;
    }
    @Nullable
    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        if(bean.getClass()==User.class){
            System.out.println(&quot;è°ƒç”¨postProcessAfterInitialization...&quot;);
        }
        return bean;
    }
}
</code></pre>
<p>MainConfigç±»ï¼ŒSpringBootç¨‹åºè¿è¡Œçš„ä¸»ç±»ï¼Œå¹¶å°†Userå’ŒCustomBeanPostProcessor åŠ å…¥åˆ°å®¹å™¨ä¸­</p>
<pre><code>package com.itbofeng;
import com.itbofeng.bean.User;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
@SpringBootApplication
public class MainConfig {
    public static void main(String[] args) {
        SpringApplication.run(MainConfig.class,args);
    }
    @Bean(initMethod = &quot;initMethod&quot;,destroyMethod = &quot;destroyMethod&quot;)
    public User user(){
        return new User();
    }
}
</code></pre>
<p>è¿è¡Œç»“æœæŸ¥çœ‹<br>
<img src="https://upload-images.jianshu.io/upload_images/8069900-af8e044c834478ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="è¿è¡Œç»“æœ.png"></p>
<h1 id="æºç è§£æ">æºç è§£æ</h1>
<p>åˆå§‹åŒ–è¿‡ç¨‹<br>
é¦–å…ˆæˆ‘ä»¬å°†æ–­ç‚¹æ‰“åˆ°CustomBeanPostProcessor.postProcessBeforeInitializationçš„ç¬¬ä¸€è¡Œä»£ç ï¼Œç„¶åæˆ‘çœ‹ä¸€ä¸‹å…¶æ–¹æ³•è°ƒç”¨æ ˆï¼š<br>
![æ–¹æ³•è°ƒç”¨æ ˆ.png]<img src="https://bofengsun.github.io//post-images/1577242577818.png" alt=""><br>
ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯å®¹å™¨åˆ·æ–°ï¼Œç¬¬äºŒä¸ªæ˜¯åˆå§‹åŒ–Beanï¼Œæˆ‘ä»¬å…ˆå¯¹è¿™å®¹å™¨åˆ·æ–°çš„æºç è¿›è¡Œç®€å•æŸ¥çœ‹</p>
<pre><code>public void refresh() throws BeansException, IllegalStateException {
		synchronized (this.startupShutdownMonitor) {
			// Prepare this context for refreshing.
			prepareRefresh();

			// Tell the subclass to refresh the internal bean factory.
			ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();

			// Prepare the bean factory for use in this context.
			prepareBeanFactory(beanFactory);

			try {
				// Allows post-processing of the bean factory in context subclasses.
				postProcessBeanFactory(beanFactory);

				// Invoke factory processors registered as beans in the context.
				invokeBeanFactoryPostProcessors(beanFactory);

				// Register bean processors that intercept bean creation.
				registerBeanPostProcessors(beanFactory);

				// Initialize message source for this context.
				initMessageSource();

				// Initialize event multicaster for this context.
				initApplicationEventMulticaster();

				// Initialize other special beans in specific context subclasses.
				onRefresh();

				// Check for listener beans and register them.
				registerListeners();

				// Instantiate all remaining (non-lazy-init) singletons.
				finishBeanFactoryInitialization(beanFactory);

				// Last step: publish corresponding event.
				finishRefresh();
			}

			catch (BeansException ex) {
				if (logger.isWarnEnabled()) {
					logger.warn(&quot;Exception encountered during context initialization - &quot; +
							&quot;cancelling refresh attempt: &quot; + ex);
				}

				// Destroy already created singletons to avoid dangling resources.
				destroyBeans();

				// Reset 'active' flag.
				cancelRefresh(ex);

				// Propagate exception to caller.
				throw ex;
			}

			finally {
				// Reset common introspection caches in Spring's core, since we
				// might not ever need metadata for singleton beans anymore...
				resetCommonCaches();
			}
		}
	}
</code></pre>
<p>æ³¨æ„<strong>finishBeanFactoryInitialization</strong>ï¼Œä¸Šé¢è¯´æ˜ä¹Ÿè§£é‡Šè¯´è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯åˆå§‹åŒ–æ‰€æœ‰å‰©ä¸‹çš„éæ‡’åŠ è½½çš„å•ä¾‹Bean,ä»è¯¥æè¿°ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œæ‡’åŠ è½½å’ŒåŸå‹çš„Beanåœ¨è¯¥é˜¶æ®µå¹¶ä¸ä¼šè¢«åŠ è½½ï¼Œè¿™éƒ¨åˆ†ä»£ç æ˜¯Springå®¹å™¨åˆ·æ–°æ—¶çš„ä»£ç ï¼Œä¹Ÿæ˜¯Spring IOCæ¯”è¾ƒæ ¸å¿ƒçš„ä»£ç ï¼Œåœ¨å­¦ä¹ åé¢ä¸­ï¼Œæ…¢æ…¢å°†è¯¥éƒ¨åˆ†çš„ä»£ç æ…¢æ…¢å­¦ä¹ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹åˆå§‹åŒ–Beanéƒ¨åˆ†çš„ä»£ç ï¼š</p>
<pre><code>protected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) {
	//å¯¹å®ç°äº†Awareæ¥å£çš„æ–¹æ³•è¿›è¡Œæ‰§è¡Œï¼Œæ–¹æ³•å°±åœ¨ä¸‹æ–¹ï¼Œä½¿ç”¨æ–¹æ³•ç›´æ¥å®ç°å¯¹åº”çš„Awareæ¥å£å³å¯
	if (System.getSecurityManager() != null) {
		AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; {
			invokeAwareMethods(beanName, bean);
			return null;
		}, getAccessControlContext());
	}
	else {
		invokeAwareMethods(beanName, bean);
	}

	Object wrappedBean = bean;
	if (mbd == null || !mbd.isSynthetic()) {
		//æ‰§è¡Œå®ç°äº†BeanPostProcessorçš„postProcessBeforeInitializationæ–¹æ³•
		wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);
	}

	try {
		//æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•
		invokeInitMethods(beanName, wrappedBean, mbd);
	}
	catch (Throwable ex) {
		throw new BeanCreationException(
				(mbd != null ? mbd.getResourceDescription() : null),
				beanName, &quot;Invocation of init method failed&quot;, ex);
	}
	if (mbd == null || !mbd.isSynthetic()) {
		//æ‰§è¡Œå®ç°äº†BeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•
		wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
	}

	return wrappedBean;
}

private void invokeAwareMethods(final String beanName, final Object bean) {
	if (bean instanceof Aware) {
		if (bean instanceof BeanNameAware) {
			((BeanNameAware) bean).setBeanName(beanName);
		}
		if (bean instanceof BeanClassLoaderAware) {
			ClassLoader bcl = getBeanClassLoader();
			if (bcl != null) {
				((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);
			}
		}
		if (bean instanceof BeanFactoryAware) {
			((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this);
		}
	}
}

protected void invokeInitMethods(String beanName, final Object bean, @Nullable RootBeanDefinition mbd)
			throws Throwable {

	boolean isInitializingBean = (bean instanceof InitializingBean);
	if (isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))) {
		if (logger.isDebugEnabled()) {
			logger.debug(&quot;Invoking afterPropertiesSet() on bean with name '&quot; + beanName + &quot;'&quot;);
		}
		//è°ƒç”¨InitializingBeançš„afterPropertiesSetæ–¹æ³•
		if (System.getSecurityManager() != null) {
			try {
				AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; {
					((InitializingBean) bean).afterPropertiesSet();
					return null;
				}, getAccessControlContext());
			}
			catch (PrivilegedActionException pae) {
				throw pae.getException();
			}
		}
		else {
			((InitializingBean) bean).afterPropertiesSet();
		}
	}
	//è°ƒç”¨@Beanåˆ¶å®šçš„çš„initMethodæ–¹æ³•
	if (mbd != null &amp;&amp; bean.getClass() != NullBean.class) {
		String initMethodName = mbd.getInitMethodName();
		if (StringUtils.hasLength(initMethodName) &amp;&amp;
				!(isInitializingBean &amp;&amp; &quot;afterPropertiesSet&quot;.equals(initMethodName)) &amp;&amp;
				!mbd.isExternallyManagedInitMethod(initMethodName)) {
			invokeCustomInitMethod(beanName, bean, mbd);
		}
	}
}
</code></pre>
<p>ä»¥ä¸Šå°±æ˜¯åˆå§‹åŒ–é˜¶æ®µï¼Œæˆ‘ä»¬ä¼šå‘ç°åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ²¡æœ‰@PostConstructæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ï¼Œé‚£æ˜¯å› ä¸ºå¯¹@PostConstructçš„å¤„ç†ä¹Ÿæ˜¯BeanPostProcessorçš„å®ç°ç±»<strong>InitDestroyAnnotationBeanPostProcessor</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åº”è¯¥æœ‰ç–‘é—®ä¸ºä»€ä¹ˆInitDestroyAnnotationBeanPostProcessor.postProcessBeforeDestructionä¸ºä»€ä¹ˆä¼šåœ¨CustomBeanPostProcessor.postProcessBeforeInitializationä¹‹åè¿›è¡Œï¼Œæ˜¯å› ä¸ºå¦‚æœä¸æŒ‡å®šé¡ºåºé»˜è®¤æˆ‘ä»¬çš„getOrderä¸º0ï¼Œè€ŒInitDestroyAnnotationBeanPostProcessorçš„getOrderä¸ºOrdered.LOWEST_PRECEDENCE=2147483647,getOrderè¶Šå¤§åˆ™ï¼Œä¼˜å…ˆçº§è¶Šä½ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„åœ¨å…¶ä¹‹å‰ï¼Œè‡³æ­¤åˆå§‹åŒ–éƒ¨åˆ†ç»“æŸã€‚<br>
ä¸‹é¢æˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸‹é”€æ¯é˜¶æ®µï¼š</p>
<pre><code>public void destroy() {
	//å¤„ç†@PreDestroyæ³¨è§£æ³¨é‡Šçš„æ–¹æ³•
	if (!CollectionUtils.isEmpty(this.beanPostProcessors)) {
		for (DestructionAwareBeanPostProcessor processor : this.beanPostProcessors) {
			processor.postProcessBeforeDestruction(this.bean, this.beanName);
		}
	}
	//å¤„ç†å®ç°äº†DisposableBeanæ¥å£çš„destroyçš„æ–¹æ³•
	if (this.invokeDisposableBean) {
		if (logger.isDebugEnabled()) {
			logger.debug(&quot;Invoking destroy() on bean with name '&quot; + this.beanName + &quot;'&quot;);
		}
		try {
			if (System.getSecurityManager() != null) {
				AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; {
					((DisposableBean) bean).destroy();
					return null;
				}, acc);
			}
			else {
				((DisposableBean) bean).destroy();
			}
		}
		catch (Throwable ex) {
			String msg = &quot;Invocation of destroy method failed on bean with name '&quot; + this.beanName + &quot;'&quot;;
			if (logger.isDebugEnabled()) {
				logger.warn(msg, ex);
			}
			else {
				logger.warn(msg + &quot;: &quot; + ex);
			}
		}
	}
	//å¤„ç†@BeanæŒ‡å®šçš„destroyMethodæ–¹æ³•
	if (this.destroyMethod != null) {
		invokeCustomDestroyMethod(this.destroyMethod);
	}
	else if (this.destroyMethodName != null) {
		Method methodToCall = determineDestroyMethod(this.destroyMethodName);
		if (methodToCall != null) {
			invokeCustomDestroyMethod(methodToCall);
		}
	}
}
</code></pre>
<h1 id="ç»“æŸè¯­">ç»“æŸè¯­</h1>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬Beançš„ç”Ÿå‘½å‘¨æœŸæ¢ç´¢åˆæ­¥ç»“æŸï¼Œåé¢å†åšè¿›ä¸€æ­¥æ·±å…¥å­¦ä¹ ï¼Œåœ¨å­¦ä¹ æœ¬èŠ‚è¯¾æ—¶è¦å¤šè¿›è¡Œè°ƒè¯•ï¼Œæ–­ç‚¹è·Ÿè¸ªï¼Œä¼šæ›´åŠ æœ‰æ•ˆæœã€‚å¦å¤–æ— è®ºæ˜¯åœ¨åˆå§‹åŒ–è¿˜æ˜¯åœ¨ç»“æŸæ—¶éƒ½æ˜¯å¤„ç†çš„å•ä¾‹çš„Bean,è€Œä¸”åœ¨åˆå§‹åŒ–æ—¶ï¼Œå¤„ç†çš„Beanè¿˜æ˜¯éæ‡’åŠ è½½çš„ï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šè¯´æ˜ï¼š<strong>éæ‡’åŠ è½½çš„å•å®ä¾‹Beançš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸Š;æ‡’åŠ è½½çš„å•å®ä¾‹Beanæ˜¯åœ¨ç¬¬ä¸€æ¬¡è·å–è¿›è¡Œåˆå§‹åŒ–è¿‡ç¨‹;åŸå‹Beanæ˜¯åœ¨æ¯æ¬¡è·å–æ—¶éƒ½è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œä¸”Springå®¹å™¨ä¸ä¼šç®¡ç†å™¨é”€æ¯ã€‚</strong><br>
æœ€è¿‘åœ¨ç½‘ä¸Šçœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼Œå¾ˆä¸é”™ï¼Œè¯¦ç»†çš„ä»‹ç»äº†Spring IOCçš„åŸç†ï¼Œå¦‚æœå¤§å®¶æƒ³è¯¦ç»†äº†è§£Springçš„IOCå¯ä»¥çœ‹ä¸€ä¸‹ï¼šhttps://www.cnblogs.com/ITtangtang/p/3978349.htmlï¼Œå¥½ä¸œè¥¿å¤§å®¶ä¸€èµ·åˆ†äº«ï¼ŒğŸŒ¹ğŸ€ğŸğŸ’°ğŸ“±ğŸŒ™ğŸğŸ‚ğŸƒğŸŒ·ğŸ’ğŸ”«ğŸ€âš½âš¡ğŸ‘„ğŸ”¥</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç›¸æ€ç›¸å®ˆ]]></title>
        <id>https://bofengsun.github.io//post/xiang-si-xiang-shou</id>
        <link href="https://bofengsun.github.io//post/xiang-si-xiang-shou">
        </link>
        <updated>2019-12-16T05:51:45.000Z</updated>
        <summary type="html"><![CDATA[<p>é•¿ç›¸æ€ï¼Œé•¿ç›¸æ€ã€‚è‹¥é—®ç›¸æ€ç”šäº†æœŸï¼Œé™¤éç›¸è§æ—¶ã€‚<br>
æ€•ç›¸æ€ï¼Œå·²ç›¸æ€ï¼Œè½®åˆ°ç›¸æ€æ— å¤„è¾ï¼Œçœ‰é—´éœ²ä¸€ä¸ã€‚</p>
<p>é•¿ç›¸å®ˆï¼Œé•¿ç›¸å®ˆï¼Œæ‰§å­ç›¸å®ˆå¯„æ— æœŸï¼Œä½†å‡­é£é›¨å¤„ã€‚<br>
å¿µç›¸å®ˆï¼Œå¯„ç›¸å®ˆï¼Œå•å­ç›¸å®ˆæ·±æƒ…å¤„ï¼Œæ€€ä¸­ä¿¯é¦–æ—¶ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>é•¿ç›¸æ€ï¼Œé•¿ç›¸æ€ã€‚è‹¥é—®ç›¸æ€ç”šäº†æœŸï¼Œé™¤éç›¸è§æ—¶ã€‚<br>
æ€•ç›¸æ€ï¼Œå·²ç›¸æ€ï¼Œè½®åˆ°ç›¸æ€æ— å¤„è¾ï¼Œçœ‰é—´éœ²ä¸€ä¸ã€‚</p>
<p>é•¿ç›¸å®ˆï¼Œé•¿ç›¸å®ˆï¼Œæ‰§å­ç›¸å®ˆå¯„æ— æœŸï¼Œä½†å‡­é£é›¨å¤„ã€‚<br>
å¿µç›¸å®ˆï¼Œå¯„ç›¸å®ˆï¼Œå•å­ç›¸å®ˆæ·±æƒ…å¤„ï¼Œæ€€ä¸­ä¿¯é¦–æ—¶ã€‚</p>
<!-- more -->
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å•ç‚¹ç™»é™†ï¼ˆSSOï¼‰ä»‹ç»]]></title>
        <id>https://bofengsun.github.io//post/dan-dian-deng-lu-ssojie-shao</id>
        <link href="https://bofengsun.github.io//post/dan-dian-deng-lu-ssojie-shao">
        </link>
        <updated>2019-11-26T05:23:34.000Z</updated>
        <summary type="html"><![CDATA[<p>å•ç‚¹ç™»é™†æ˜¯å¾ˆå¤šä¼ä¸šè¿›è¡Œä¼ä¸šé¡¹ç›®æ•´åˆéƒ½ä¼šç”¨åˆ°çš„æŠ€æœ¯ï¼Œå•ç‚¹ç™»é™†ä¸»è¦ä½œç”¨æ˜¯ç®€åŒ–ç”¨æˆ·è®¤è¯æµç¨‹ï¼Œå³ç™»é™†ä¸€æ¬¡å³å¯è®¿é—®å¤šä¸ªç³»ç»Ÿï¼Œé€€å‡ºä¸€æ¬¡å…¨éƒ¨é€€å‡ºã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>å•ç‚¹ç™»é™†æ˜¯å¾ˆå¤šä¼ä¸šè¿›è¡Œä¼ä¸šé¡¹ç›®æ•´åˆéƒ½ä¼šç”¨åˆ°çš„æŠ€æœ¯ï¼Œå•ç‚¹ç™»é™†ä¸»è¦ä½œç”¨æ˜¯ç®€åŒ–ç”¨æˆ·è®¤è¯æµç¨‹ï¼Œå³ç™»é™†ä¸€æ¬¡å³å¯è®¿é—®å¤šä¸ªç³»ç»Ÿï¼Œé€€å‡ºä¸€æ¬¡å…¨éƒ¨é€€å‡ºã€‚</p>
<!-- more -->
<h2 id="1-äº§ç”ŸèƒŒæ™¯">1ã€äº§ç”ŸèƒŒæ™¯</h2>
<p>å•ç‚¹ç™»é™†çš„äº§ç”Ÿä¸»è¦æ˜¯éšç€ä¼ä¸šä¸šåŠ¡çš„å‘å±•ï¼Œä¼ä¸šä¼šæœ‰è®¸å¤šç³»ç»Ÿæ¥å¤„ç†ä¸é€šçš„ä¸šåŠ¡ï¼Œè€Œå¦‚æœå„ä¸ªç³»ç»Ÿå‡å•ç‹¬åšç™»é™†è®¤è¯åŠŸèƒ½ï¼Œä¼šé€ æˆå¤šä¸ªç³»ç»Ÿéƒ½éœ€è¦å¼€å‘ä¸€æ ·çš„è®¤è¯é€»è¾‘çš„åŠŸèƒ½ï¼Œè€Œä¸”ç”¨æˆ·åœ¨ä½¿ç”¨æ—¶ä¹Ÿéœ€è¦é¢‘ç¹çš„è¿›è¡Œç™»é™†é€€å›ï¼Œè€Œå•ç‚¹ç™»é™†ï¼Œå°±æ˜¯å¤šä¸ªç³»ç»Ÿå…±åŒä¿¡ä»»åŒä¸€ä»½ç¥¨æ®ï¼Œè¿™ä»½ç¥¨æ®ï¼Œå¯ä»¥åœ¨å„ä¸ªä¸šåŠ¡ç³»ç»Ÿä¸­è¿›è¡Œä½¿ç”¨ï¼Œä»¥æ­¤æ¥å®ç°èº«ä»½è®¤è¯çš„ç»„åˆã€‚</p>
<h2 id="2-å®ç°æµç¨‹">2ã€å®ç°æµç¨‹</h2>
<p>1ã€ç”¨æˆ·1ç™»é™†ä¸šåŠ¡ç³»ç»Ÿ1<br>
2ã€æ£€æŸ¥æ²¡æœ‰æºå¸¦å‡­æ®ï¼Œè®©æµè§ˆå™¨é‡å®šå‘SSO Server ç™»é™†éªŒè¯å¹¶æºå¸¦è‡ªå½“å‰è¯·æ±‚è·¯å¾„ï¼ˆè·¯å¾„1ï¼‰<br>
3ã€ç”¨æˆ·æ²¡æœ‰ç™»é™†ï¼Œè·³è½¬åˆ°ç™»é™†é¡µé¢å¹¶æºå¸¦ï¼ˆè·¯å¾„1ï¼‰<br>
4ã€ç”¨æˆ·ç™»é™†ï¼Œå¹¶ä¿å­˜å‡­æ®ï¼Œé‡å®šå‘åˆ°ï¼ˆè·¯å¾„1ï¼‰ï¼Œå¹¶æºå¸¦å‡­æ®<br>
5ã€ä¸šåŠ¡ç³»ç»Ÿ1 å­˜å‚¨å‡­æ®<br>
6ã€ç”¨æˆ·2ç™»é™†ä¸šåŠ¡ç³»ç»Ÿ2<br>
7ã€æ£€æŸ¥æ²¡æœ‰æºå¸¦å‡­æ®ï¼Œè®©æµè§ˆå™¨é‡å®šå‘SSO Server ç™»é™†éªŒè¯å¹¶æºå¸¦è‡ªå½“å‰è¯·æ±‚è·¯å¾„ï¼ˆè·¯å¾„2ï¼‰<br>
8ã€ç”¨æˆ·å·²ç™»é™†ï¼Œé‡å®šå‘åˆ°ï¼ˆè·¯å¾„2ï¼‰ï¼Œå¹¶æºå¸¦å‡­æ®<br>
9ã€ä¸šåŠ¡ç³»ç»Ÿ2ï¼Œå­˜å‚¨å‡­æ®</p>
<h2 id="3-å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„åŠŸèƒ½">3ã€å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„åŠŸèƒ½</h2>
<p>å®¢æˆ·ç«¯ï¼š<br>
1ã€æ‹¦æˆªå­ç³»ç»Ÿæœªç™»å½•ç”¨æˆ·è¯·æ±‚ï¼Œè·³è½¬è‡³ssoè®¤è¯ä¸­å¿ƒ<br>
2ã€æ¥æ”¶å¹¶å­˜å‚¨ssoè®¤è¯ä¸­å¿ƒå‘é€çš„ä»¤ç‰Œ<br>
3ã€ä¸æœåŠ¡å™¨ç«¯é€šä¿¡ï¼Œæ ¡éªŒä»¤ç‰Œçš„æœ‰æ•ˆæ€§<br>
4ã€å»ºç«‹å±€éƒ¨ä¼šè¯<br>
5ã€æ‹¦æˆªç”¨æˆ·æ³¨é”€è¯·æ±‚ï¼Œå‘ssoè®¤è¯ä¸­å¿ƒå‘é€æ³¨é”€è¯·æ±‚<br>
æœåŠ¡å™¨ç«¯ï¼š<br>
1ã€éªŒè¯ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯<br>
2ã€åˆ›å»ºå…¨å±€ä¼šè¯<br>
3ã€åˆ›å»ºæˆæƒä»¤ç‰Œ<br>
4ã€ä¸å®¢æˆ·ç«¯é€šä¿¡å‘é€ä»¤ç‰Œ<br>
6ã€æ ¡éªŒå®¢æˆ·ç«¯ä»¤ç‰Œæœ‰æ•ˆæ€§<br>
7ã€æ¥æ”¶å®¢æˆ·ç«¯æ³¨é”€è¯·æ±‚ï¼Œæ³¨é”€ä¼šè¯</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Shiro å¯†ç åŠ å¯†ä¸ä¼šè¯ç®¡ç†ä»‹ç»]]></title>
        <id>https://bofengsun.github.io//post/shiro-mi-ma-jia-mi</id>
        <link href="https://bofengsun.github.io//post/shiro-mi-ma-jia-mi">
        </link>
        <updated>2019-11-14T15:54:05.000Z</updated>
        <summary type="html"><![CDATA[<p>å¯†ç åŠ å¯†ä¸»è¦æ˜¯åœ¨ç”¨æˆ·ç™»å½•ä¸æ³¨å†Œçš„æ—¶å€™è¿›è¡Œçš„ï¼Œç”¨æˆ·åœ¨æ³¨å†Œæ—¶ç”Ÿæˆå¯†ç ï¼Œé€šè¿‡åŠ å¯†å­˜å‚¨å¯†æ–‡åˆ°æ•°æ®åº“ä¸­ï¼Œç”¨æˆ·åœ¨ç™»å½•æ—¶å€™ï¼Œå°†å‰å°ç”¨æˆ·å¡«å†™çš„å¯†ç å†æ¬¡è¿›è¡ŒåŠ å¯†ä¸æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ï¼Œä¸€è‡´å³å¯é€šè¿‡ï¼›ä¼šè¯ç®¡ç†ä¸»è¦æ—¶ç±»ä¼¼Sessionã€Tokençš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç®€å•è®¤è¯†ä¸€ä¸‹Shiroçš„å¯†ç åŠ å¯†å’Œä¼šè¯ç®¡ç†ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>å¯†ç åŠ å¯†ä¸»è¦æ˜¯åœ¨ç”¨æˆ·ç™»å½•ä¸æ³¨å†Œçš„æ—¶å€™è¿›è¡Œçš„ï¼Œç”¨æˆ·åœ¨æ³¨å†Œæ—¶ç”Ÿæˆå¯†ç ï¼Œé€šè¿‡åŠ å¯†å­˜å‚¨å¯†æ–‡åˆ°æ•°æ®åº“ä¸­ï¼Œç”¨æˆ·åœ¨ç™»å½•æ—¶å€™ï¼Œå°†å‰å°ç”¨æˆ·å¡«å†™çš„å¯†ç å†æ¬¡è¿›è¡ŒåŠ å¯†ä¸æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ï¼Œä¸€è‡´å³å¯é€šè¿‡ï¼›ä¼šè¯ç®¡ç†ä¸»è¦æ—¶ç±»ä¼¼Sessionã€Tokençš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç®€å•è®¤è¯†ä¸€ä¸‹Shiroçš„å¯†ç åŠ å¯†å’Œä¼šè¯ç®¡ç†ã€‚</p>
<!-- more -->
<h1 id="shiro-å¯†ç åŠ å¯†">Shiro å¯†ç åŠ å¯†</h1>
<h2 id="0-å‰ç½®ä»£ç åé¢ç”¨åˆ°ä»¥ä¾¿ç†è§£">0ã€å‰ç½®ä»£ç :åé¢ç”¨åˆ°ï¼Œä»¥ä¾¿ç†è§£</h2>
<pre><code class="language-Java">    /**
     * åŠ å¯†æ¬¡æ•°
     */
    Integer HASH_ITERATIONS=1024;
    /**
     * åŠ å¯†ç®—æ³•
     */
    String HASH_ALGORITHMNAME=&quot;MD5&quot;;
</code></pre>
<h2 id="1-æ³¨å†Œæ³¨å†Œå’Œè®¤è¯æ—¶å¯†ç éœ€è¦ç”¨åŒæ ·çš„ç­–ç•¥ä»¥ä¿è¯å¯†ç å¯†æ–‡çš„ä¸€è‡´æ€§">1ã€æ³¨å†Œï¼šæ³¨å†Œå’Œè®¤è¯æ—¶å¯†ç éœ€è¦ç”¨åŒæ ·çš„ç­–ç•¥ï¼Œä»¥ä¿è¯å¯†ç å¯†æ–‡çš„ä¸€è‡´æ€§ã€‚</h2>
<pre><code class="language-Java">    /**
     * æ³¨å†Œ
     * @param registerVo
     * @return
     */
    @PostMapping(&quot;/register&quot;)
    public ResultVo&lt;Boolean&gt; register(@RequestBody LoginRegisterVo registerVo){
        //åŠ å¯†æ–¹å¼ å¯å¦è¡Œåˆ¶å®š
        String algorithmName= Constant.HASH_ALGORITHMNAME;
        //å¯†ç æ˜æ–‡
        Object source=registerVo.getPassword();
        //å¯†ç ç›å€¼ å¯å¦è¡Œåˆ¶å®š
        Object salt=registerVo.getUsername();
        //åŠ å¯†æ¬¡æ•° å¯å¦è¡Œåˆ¶å®š
        int hashIterations=Constant.HASH_ITERATIONS;
        SimpleHash simpleHash = new SimpleHash(algorithmName, source, salt, hashIterations);
        //åŠ å¯†åå¯†ç 
        String password = simpleHash.toHex();
        log.info(password);
        boolean flag=userService.addUser(registerVo.getUsername(),password);
        if(!flag){
            ResultVo.failure(Result.REGISTER_FAILURE);
        }
        return ResultVo.success(true);
    }
</code></pre>
<p>æ ¹æ®ä»¥ä¸Šæ³¨å†Œå¯ç”Ÿæˆå¯†ç ï¼Œé‚£ä¹ˆåœ¨ç™»é™†çš„æ—¶å€™ï¼Œè¯¥å¦‚ä½•è¿›è¡ŒåŒ¹é…å‘¢ï¼Ÿä¸‹é¢æˆ‘æ¥çœ‹ä¸€ä¸‹ç™»å½•å¦‚ä½•è¿›è¡Œ</p>
<h2 id="2-è®¤è¯åœ¨è¿›è¡Œç”¨æˆ·è®¤è¯dogetauthenticationinfoæ—¶éœ€è¦æŒ‡å®šç›å€¼é¢œå€¼éœ€è¦å”¯ä¸€">2ã€è®¤è¯ï¼šåœ¨è¿›è¡Œç”¨æˆ·è®¤è¯(doGetAuthenticationInfo)æ—¶éœ€è¦æŒ‡å®šç›å€¼ï¼Œé¢œå€¼éœ€è¦å”¯ä¸€</h2>
<pre><code class="language-Java">    /**
     * å®ç°è¯¥æ–¹æ³•è¿›è¡Œè®¤è¯ï¼Œåœ¨è°ƒç”¨Subject#loginçš„æ—¶å€™ä¼šè¿›å…¥è¯¥æ–¹æ³•
     * @param authenticationToken ä»¤ç‰Œ
     * @return è®¤è¯çš„ä¿¡æ¯
     * @throws AuthenticationException è®¤è¯å¼‚å¸¸
     */
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        log.info(&quot;å¼€å§‹è¿›è¡Œèº«ä»½è®¤è¯ï¼&quot;);
        UsernamePasswordToken usernamePasswordToken=(UsernamePasswordToken)authenticationToken;
        String username = usernamePasswordToken.getUsername();
        User user = userService.getByUsername(username);
        if(user==null){
            log.info(&quot;ç”¨æˆ·æœªæ‰¾åˆ°ï¼&quot;);
            throw new UnknownAccountException(Result.LOGIN_FAILURE.getMsg());
        }else if (Constant.USER_LOCKED.equals(user.getStatus())){
            log.info(&quot;ç”¨æˆ·è¢«é”å®šï¼&quot;);
            throw new LockedAccountException(Result.LOGIN_FAILURE_LOCK.getMsg());
        }else {
            Object principal=user.getId();
            String credentials=user.getPassword();
            String realmName=getName();
            //æŒ‡å®šç›å€¼
            ByteSource credentialsSalt = ByteSource.Util.bytes(usernamePasswordToken.getUsername());
            SimpleAuthenticationInfo simpleAuthenticationInfo=new SimpleAuthenticationInfo(principal,credentials,credentialsSalt,realmName);
            log.info(&quot;ç”¨æˆ·è®¤è¯ï¼&quot;);
            return simpleAuthenticationInfo;
        }
    }
</code></pre>
<h2 id="3-é…ç½®realmåœ¨realmå¯†ç ç­–ç•¥ä»¥åŠåŠ å¯†æ¬¡æ•°">3ã€é…ç½®Realm:åœ¨Realmå¯†ç ç­–ç•¥ä»¥åŠåŠ å¯†æ¬¡æ•°</h2>
<pre><code class="language-Java">    /**
     * é…ç½®è‡ªå®šä¹‰çš„Realm
     * @return CustomRealm
     */
    @Bean
    public CustomRealm customRealm() {
        CustomRealm customRealm = new CustomRealm();
        HashedCredentialsMatcher credentialsMatcher = new HashedCredentialsMatcher(Constant.HASH_ALGORITHMNAME);
        credentialsMatcher.setHashIterations(Constant.HASH_ITERATIONS);
        customRealm.setCredentialsMatcher(credentialsMatcher);
        return customRealm;
    }
</code></pre>
<h2 id="4-æ‰©å±•">4ã€æ‰©å±•</h2>
<p>å®é™…ä¸ŠShiroæ”¯æŒå¤šç§å¯†ç ç­–ç•¥ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹org.apache.shiro.authc.credential.CredentialsMatcherçš„å­ç±»</p>
<h1 id="shiro-ä¼šè¯ç®¡ç†">Shiro ä¼šè¯ç®¡ç†</h1>
<h2 id="1-ä½¿ç”¨å½“å‰ä¼šè¯">1ã€ä½¿ç”¨å½“å‰ä¼šè¯</h2>
<pre><code class="language-Java">    SecurityUtils.getSubject().getSession();
</code></pre>
<h2 id="2-ä¼šè¯ç®¡ç†å™¨sessionmanagerç®¡ç†sessionåŒ…æ‹¬åˆ›å»º-ç»´æŠ¤-åˆ é™¤-å¤±æ•ˆ-éªŒè¯ç­‰å·¥ä½œ">2ã€ä¼šè¯ç®¡ç†å™¨(SessionManager):ç®¡ç†sessionåŒ…æ‹¬åˆ›å»ºã€ç»´æŠ¤ã€åˆ é™¤ã€å¤±æ•ˆã€éªŒè¯ç­‰å·¥ä½œã€‚</h2>
<pre><code class="language-Java">/**
 * è‡ªå®šä¹‰SessionManager:ä»è¯·æ±‚å¤´ä¸­ä¹Ÿå¯è·å–JSESSIONID
 */
@Slf4j
public class CustomWebSessionManager extends DefaultWebSessionManager{

    private static final String JSESSIONID=&quot;JSESSIONID&quot;;

    @Override
    protected Serializable getSessionId(ServletRequest request, ServletResponse response) {
        Serializable id = super.getSessionId(request,response);
        //å¦‚æœä»Cookieä¸­æ²¡æœ‰è·å–åˆ°SessionId,åˆ™ä»è¯·æ±‚å¤´ä¸­è·å–
        if (id == null) {
            id=WebUtils.toHttp(request).getHeader(JSESSIONID);
        }
        return id;
    }
}
</code></pre>
<h2 id="3-ä¼šè¯ç›‘å¬å™¨sessionlistenerç›‘å¬ä¼šè¯çŠ¶æ€è§¦å‘å¯¹åº”çš„æ–¹æ³•">3ã€ä¼šè¯ç›‘å¬å™¨(SessionListener):ç›‘å¬ä¼šè¯çŠ¶æ€ï¼Œè§¦å‘å¯¹åº”çš„æ–¹æ³•</h2>
<pre><code class="language-Java">/**
 * è‡ªå®šä¹‰SerssionListener ç»´æŠ¤Sessionä¸­çš„å€¼
 */
public class CustomSessionListener implements SessionListener {
    @Override
    public void onStart(Session session) {
        RedisUtil.set(session.getId().toString(),session);
    }

    @Override
    public void onStop(Session session) {
        RedisUtil.del(session.getId().toString());
    }

    @Override
    public void onExpiration(Session session) {
        RedisUtil.del(session.getId().toString());
    }
}
</code></pre>
<h2 id="4-ä¼šè¯å¢åˆ æ”¹æŸ¥æ¥å£sessiondao">4ã€ä¼šè¯å¢åˆ æ”¹æŸ¥æ¥å£(SessionDAO)</h2>
<pre><code class="language-Java">public interface SessionDAO {
    Serializable create(Session var1);

    Session readSession(Serializable var1) throws UnknownSessionException;

    void update(Session var1) throws UnknownSessionException;

    void delete(Session var1);

    Collection&lt;Session&gt; getActiveSessions();
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Shiro æƒé™è®¤è¯]]></title>
        <id>https://bofengsun.github.io//post/shiro-quan-xian-ren-zheng</id>
        <link href="https://bofengsun.github.io//post/shiro-quan-xian-ren-zheng">
        </link>
        <updated>2019-11-13T04:39:28.000Z</updated>
        <summary type="html"><![CDATA[<p>å‰é¢å‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°Shiroçš„å‡ ä¸ªä¸»è¦åŠŸèƒ½ä¸­ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬äº†æƒé™è®¤è¯ï¼Œé‚£ä¹ˆè¿™ä¸€èŠ‚ æˆ‘ä»¬å°±ç®€å•ä½“éªŒä¸€ä¸‹Shiroçš„æƒé™è®¤è¯å§ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>å‰é¢å‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°Shiroçš„å‡ ä¸ªä¸»è¦åŠŸèƒ½ä¸­ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬äº†æƒé™è®¤è¯ï¼Œé‚£ä¹ˆè¿™ä¸€èŠ‚ æˆ‘ä»¬å°±ç®€å•ä½“éªŒä¸€ä¸‹Shiroçš„æƒé™è®¤è¯å§ã€‚</p>
<!-- more -->
<h2 id="1-å®ç°æƒé™è®¤è¯é€»è¾‘">1ã€å®ç°æƒé™è®¤è¯é€»è¾‘</h2>
<p>åŸºäºå‰é¢çš„æ–‡ç« ï¼Œè‡ªå®šä¹‰Realmç»§æ‰¿AuthorizingRealm éœ€è¦å®ç°doGetAuthenticationInfo å’Œ doGetAuthorizationInfo,å…¶ä¸­doGetAuthenticationInfoä¸»è¦ç”¨æ¥èº«ä»½è®¤è¯ï¼ŒdoGetAuthorizationInfoä¸»è¦ç”¨æ¥è¿›è¡Œæƒé™è®¤è¯ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š<br>
å‰ç½®ä»£ç ï¼š</p>
<pre><code class="language-Java">    private static final Map&lt;String,Set&lt;String&gt;&gt; USER_ROLE= new HashMap&lt;&gt;();
    static {
        USER_ROLE.put(&quot;1&quot;,new HashSet&lt;&gt;(Arrays.asList(&quot;item:add&quot;,&quot;item:search&quot;,&quot;item:update&quot;,&quot;item:delete&quot;)));
        USER_ROLE.put(&quot;2&quot;,new HashSet&lt;&gt;(Arrays.asList(&quot;item:add&quot;,&quot;item:search&quot;)));
    }

    @Override
    public Set&lt;String&gt; getUserRoles(String userId) {
        Set&lt;String&gt; result = USER_ROLE.get(userId);
        return result!=null?result:Collections.EMPTY_SET;
    }
</code></pre>
<pre><code class="language-Java">    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
        log.info(&quot;å¼€å§‹è¿›è¡Œæƒé™è®¤è¯ï¼&quot;);
        SimpleAuthorizationInfo simpleAuthorizationInfo=new SimpleAuthorizationInfo();
        String userId = (String)principalCollection.getPrimaryPrincipal();
        Set&lt;String&gt; userRoles = roleService.getUserRoles(userId);
        for (String userRole:userRoles){
            simpleAuthorizationInfo.addStringPermission(userRole);
        }
        return simpleAuthorizationInfo;
    }
</code></pre>
<h2 id="2-é…ç½®lifecyclebeanpostprocessor-defaultadvisorautoproxycreator-authorizationattributesourceadvisor">2ã€é…ç½®LifecycleBeanPostProcessorã€DefaultAdvisorAutoProxyCreatorã€AuthorizationAttributeSourceAdvisor</h2>
<p>å› ä¸ºShiroéœ€è¦å¯¹Controllerè¿›è¡Œä»£ç†ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯Controllerçš„ä»£ç†ï¼Œéœ€è¦é…ç½®LifecycleBeanPostProcessorã€DefaultAdvisorAutoProxyCreatorã€AuthorizationAttributeSourceAdvisor</p>
<pre><code class="language-Java">    @Bean
    public LifecycleBeanPostProcessor lifecycleBeanPostProcessor(){
        return new LifecycleBeanPostProcessor();
    }
    @Bean
    public DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator(){
        DefaultAdvisorAutoProxyCreator creator=new DefaultAdvisorAutoProxyCreator();
        creator.setProxyTargetClass(true);
        return creator;
    }
    @Bean
    public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager) {
        AuthorizationAttributeSourceAdvisor advisor=new AuthorizationAttributeSourceAdvisor();
        advisor.setSecurityManager(securityManager);
        return advisor;
    }
</code></pre>
<h2 id="3-é…ç½®è¯·æ±‚æƒé™ç ">3ã€é…ç½®è¯·æ±‚æƒé™ç </h2>
<p>é€šè¿‡æ³¨è§£é…ç½®æƒé™ä¿¡æ¯ï¼Œ@RequiresRolesã€@RequiresPermissions ä»¥@RequiresPermissionsä¸ºä¾‹ï¼š</p>
<pre><code class="language-Java">    @RequiresPermissions(&quot;item:search&quot;)
    @GetMapping(&quot;/search&quot;)
    public ResultVo&lt;String&gt; search(){
        return ResultVo.success(&quot;search&quot;);
    }
    @RequiresPermissions(&quot;item:add&quot;)
    @GetMapping(&quot;/add&quot;)
    public ResultVo&lt;String&gt; add(){
        return ResultVo.success(&quot;add&quot;);
    }
    @RequiresPermissions(&quot;item:update&quot;)
    @GetMapping(&quot;/update&quot;)
    public ResultVo&lt;String&gt; update(){
        return ResultVo.success(&quot;update&quot;);
    }
    @RequiresPermissions(&quot;item:delete&quot;)
    @GetMapping(&quot;/delete&quot;)
    public ResultVo&lt;String&gt; delete(){
        return ResultVo.success(&quot;delete&quot;);
    }
</code></pre>
<h2 id="4-æ¼”ç¤ºæ•ˆæœ">4ã€æ¼”ç¤ºæ•ˆæœ</h2>
<p>ç”¨æˆ·ç™»é™†ï¼š<br>
<img src="https://bofengsun.github.io//post-images/1573745823357.png" alt="ç™»é™†ç”¨æˆ·"><br>
æœ‰æƒé™ï¼š<br>
<img src="https://bofengsun.github.io//post-images/1573745976892.png" alt="æœ‰æƒé™"><br>
æ— æƒé™ï¼š<br>
<img src="https://bofengsun.github.io//post-images/1573746081151.png" alt="æ— æƒé™"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Jmeter ä½“éªŒä¹‹æ—…]]></title>
        <id>https://bofengsun.github.io//post/jmeter-ti-yan-zhi-lu</id>
        <link href="https://bofengsun.github.io//post/jmeter-ti-yan-zhi-lu">
        </link>
        <updated>2019-11-12T11:23:40.000Z</updated>
        <summary type="html"><![CDATA[<p>Jmeter æ˜¯ä¸€æ¬¾æµ‹è¯•å·¥å…·ï¼Œä¸»è¦ç”¨æ¥è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä»Šå¤©å’Œæµ‹è¯•çš„åŒäº‹åœ¨èŠè¿™ä¸ªè¯é¢˜ï¼Œé¡ºä¾¿å°±ä½“éªŒäº†ä¸€ä¸‹Jmeterè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä¸‹é¢æˆ‘å°±ç®€å•æè¿°ä¸€ä¸‹ä»Šå¤©çš„ä½“éªŒå§ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>Jmeter æ˜¯ä¸€æ¬¾æµ‹è¯•å·¥å…·ï¼Œä¸»è¦ç”¨æ¥è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä»Šå¤©å’Œæµ‹è¯•çš„åŒäº‹åœ¨èŠè¿™ä¸ªè¯é¢˜ï¼Œé¡ºä¾¿å°±ä½“éªŒäº†ä¸€ä¸‹Jmeterè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œä¸‹é¢æˆ‘å°±ç®€å•æè¿°ä¸€ä¸‹ä»Šå¤©çš„ä½“éªŒå§ã€‚</p>
<!-- more -->
<h2 id="jmeter-ä»‹ç»">Jmeter ä»‹ç»</h2>
<p>Apache JMeter æ˜¯ä¸€æ¬¾å¼€æºçš„Javaå¼€å‘çš„ç”¨äºè¿›è¡Œè½¯ä»¶æ€§èƒ½æµ‹è¯•çš„è½¯ä»¶ã€‚</p>
<h2 id="å®‰è£…å’Œè¿è¡Œ">å®‰è£…å’Œè¿è¡Œ</h2>
<p>ä¸‹è½½åœ°å€ï¼šhttp://mirrors.tuna.tsinghua.edu.cn/apache//jmeter/binaries/apache-jmeter-5.2.zip<br>
è¿è¡Œï¼šwindowsç¯å¢ƒï¼š â€œbin/jmeter.batâ€   linuxç¯å¢ƒï¼š â€œbin/jmeter.shâ€<br>
åˆ‡æ¢è¯­è¨€ï¼š å¯åŠ¨Jmeter åï¼Œ ç‚¹å‡» Options -&gt; Choose Language -&gt; Chinese[Simplified]  æ¥é€‰æ‹©ç®€ä½“ä¸­æ–‡<br>
æˆªå›¾å¦‚ä¸‹ï¼š<br>
<img src="https://bofengsun.github.io//post-images/1573559262706.png" alt="Jmeter"></p>
<h2 id="æ¡ˆä¾‹">æ¡ˆä¾‹</h2>
<h3 id="æ·»åŠ é»˜è®¤è®¾ç½®">æ·»åŠ é»˜è®¤è®¾ç½®</h3>
<p>1ã€æ·»åŠ  HTTP Cookieç®¡ç†å™¨<br>
<img src="https://bofengsun.github.io//post-images/1573563560952.png" alt="HTTP Cookieç®¡ç†å™¨"><br>
2ã€æ·»åŠ  é»˜è®¤è¯·æ±‚å¤´<br>
<img src="https://bofengsun.github.io//post-images/1573563633762.png" alt="é»˜è®¤è¯·æ±‚å¤´"><br>
3ã€æ·»åŠ  é»˜è®¤è¯·æ±‚<br>
<img src="https://bofengsun.github.io//post-images/1573563677239.png" alt="é»˜è®¤è¯·æ±‚"></p>
<h3 id="æ·»åŠ çº¿ç¨‹ç»„">æ·»åŠ çº¿ç¨‹ç»„</h3>
<p>å‚æ•°è¯´æ˜ï¼š<br>
çº¿ç¨‹æ•°ï¼šè¡¨ç¤ºéœ€è¦å¯åŠ¨çš„çº¿ç¨‹æ•°é‡<br>
Ramp-Upæ—¶é—´ï¼šå¤šå°‘ç§’å†…å¯åŠ¨è¿™äº›çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šåœ¨è¿™ä¸ªæ—¶é—´å†…å¯åŠ¨è¿™ä¹ˆå¤šçº¿ç¨‹ï¼Œå¦‚æœè®¾ç½®ä¸º0ï¼Œåˆ™è¡¨ç¤ºåŒæ—¶å¯åŠ¨<br>
å¾ªç¯æ¬¡æ•°ï¼šè¡¨ç¤ºé‡å¤è¿è¡Œå¤šå°‘æ¬¡ï¼Œæ°¸è¿œè¡¨ç¤ºä¸€ç›´é‡å¤ç›´åˆ°æ—¶é—´ç»“æŸ<br>
è°ƒåº¦å™¨é…ç½®ï¼šåœ¨é…ç½®è°ƒåº¦å™¨æ—¶ç”Ÿæ•ˆï¼ŒæŒç»­æ—¶é—´ï¼šå°±æ˜¯æ‰§è¡Œå¤šä¹…<br>
<img src="https://bofengsun.github.io//post-images/1573563731549.png" alt="æ·»åŠ çº¿ç¨‹ç»„"></p>
<h3 id="æ·»åŠ å®šæ—¶å™¨">æ·»åŠ å®šæ—¶å™¨</h3>
<figure data-type="image" tabindex="1"><img src="https://bofengsun.github.io//post-images/1573609185253.png" alt="æ·»åŠ å®šæ—¶å™¨"></figure>
<h3 id="æ·»åŠ äº‹åŠ¡æ§åˆ¶å™¨">æ·»åŠ äº‹åŠ¡æ§åˆ¶å™¨</h3>
<figure data-type="image" tabindex="2"><img src="https://bofengsun.github.io//post-images/1573563817861.png" alt="äº‹åŠ¡æ§åˆ¶å™¨"></figure>
<h3 id="æ·»åŠ è¯·æ±‚">æ·»åŠ è¯·æ±‚</h3>
<figure data-type="image" tabindex="3"><img src="https://bofengsun.github.io//post-images/1573609251077.png" alt="æ·»åŠ è¯·æ±‚"></figure>
<h3 id="æ·»åŠ æ–­è¨€">æ·»åŠ æ–­è¨€</h3>
<figure data-type="image" tabindex="4"><img src="https://bofengsun.github.io//post-images/1573609303540.png" alt="æ·»åŠ æ–­è¨€"></figure>
<h3 id="æ·»åŠ æŸ¥çœ‹ç»“æœæ ‘">æ·»åŠ æŸ¥çœ‹ç»“æœæ ‘</h3>
<figure data-type="image" tabindex="5"><img src="https://bofengsun.github.io//post-images/1573609390929.png" alt="æ·»åŠ æŸ¥çœ‹ç»“æœæ ‘"></figure>
<h3 id="æ·»åŠ èšåˆæŠ¥å‘Š">æ·»åŠ èšåˆæŠ¥å‘Š</h3>
<figure data-type="image" tabindex="6"><img src="https://bofengsun.github.io//post-images/1573609486454.png" alt="æ·»åŠ èšåˆæŠ¥å‘Š"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Shiro èº«ä»½è®¤è¯ï¼ˆç»­ï¼‰]]></title>
        <id>https://bofengsun.github.io//post/shiro-authentication-2</id>
        <link href="https://bofengsun.github.io//post/shiro-authentication-2">
        </link>
        <updated>2019-11-11T05:25:45.000Z</updated>
        <summary type="html"><![CDATA[<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬ç®€å•ä»‹ç»äº†ä¸€ä¸‹Shiroçš„èº«ä»½è®¤è¯ï¼Œä½†å…¶ä¸­æœ‰äº›ç»†èŠ‚ä¹‹å¤„æˆ‘ä»¬æ²¡ç”¨è®¨è®ºåˆ°ï¼Œé‚£ä¹ˆè¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°±ä¸€äº›é—®é¢˜è¿›è¡Œä¸€ä¸‹æ€è€ƒè®¨è®ºã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬ç®€å•ä»‹ç»äº†ä¸€ä¸‹Shiroçš„èº«ä»½è®¤è¯ï¼Œä½†å…¶ä¸­æœ‰äº›ç»†èŠ‚ä¹‹å¤„æˆ‘ä»¬æ²¡ç”¨è®¨è®ºåˆ°ï¼Œé‚£ä¹ˆè¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°±ä¸€äº›é—®é¢˜è¿›è¡Œä¸€ä¸‹æ€è€ƒè®¨è®ºã€‚</p>
<!-- more -->
<h2 id="ä¸€-å¦‚ä½•å’Œæ”¯æŒweb-app-ä»¥åŠå…¶ä»–æ–¹å¼è¿›è¡Œèº«ä»½è®¤è¯">ä¸€ã€å¦‚ä½•å’Œæ”¯æŒWEBã€APPã€ä»¥åŠå…¶ä»–æ–¹å¼è¿›è¡Œèº«ä»½è®¤è¯ï¼Ÿ</h2>
<p>å…ˆå›é¡¾ä¸€ä¸‹ä¸Šä¸€èŠ‚æˆ‘ä»¬çš„ç™»é™†éƒ¨åˆ†ä»£ç ï¼š</p>
<pre><code class="language-Java">/**
 * è®¤è¯æ§åˆ¶å™¨
 */
@RestController
@RequestMapping(&quot;/auth&quot;)
@Slf4j
public class AuthController {

    /**
     * ç™»é™†
     * @param username ç”¨æˆ·å
     * @param password å¯†ç 
     * @return ç™»é™†ç»“æœ
     */
    @PostMapping(&quot;/login&quot;)
    public ResultVo&lt;String&gt; login(@RequestParam(&quot;username&quot;) String username,@RequestParam(&quot;password&quot;) String password){
        Subject currentUser = SecurityUtils.getSubject();
        if (!currentUser.isAuthenticated()) {
            UsernamePasswordToken token = new UsernamePasswordToken(username, password);
            try {
                currentUser.login(token);
                return ResultVo.success(currentUser.getSession().getId().toString());
            }catch (LockedAccountException lae) {
                return ResultVo.failure(Result.LOGIN_FAILURE_LOCK);
            }
            catch (AuthenticationException ae) {
                return ResultVo.failure(Result.LOGIN_FAILURE);
            }
        }else {
            return ResultVo.failure(Result.LOGIN_FAILURE_RELOGIN);
        }
    }
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨ç™»é™†æˆåŠŸåï¼ŒæŠŠç”¨æˆ·çš„SessionIdè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä½†åœ¨ä¼ ç»ŸWEBå…¶å®æ˜¯ä¸éœ€è¦çš„ï¼Œå› ä¸ºåœ¨è®¤è¯æˆåŠŸåä¼šå°†SessionIdä¿å­˜åœ¨cookieé‡ŒJSESSIONIDï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬éœ€è¦å…¼å®¹APPæˆ–è€…å…¶ä»–æ–¹å¼è¿™æ ·å°±è¡Œä¸é€šï¼Œä¸€ç§æ¯”è¾ƒç®€å•çš„æ–¹å¼å°±æ˜¯æˆ‘ä»¬æŠŠSessionIdè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¿å­˜ä¸€ä»½ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶ï¼Œå°†å…¶ä½œä¸ºè¯·æ±‚å¤´è¯·æ±‚æœåŠ¡ç«¯ï¼ŒåŒæ—¶æœåŠ¡ç«¯ä¹Ÿè¦æ”¹å˜è·å–SessionIdçš„æ–¹å¼ï¼Œä¸æ˜¯ä»cookieé‡Œè·å–ï¼Œè€Œæ˜¯ä»headeré‡Œè·å–ï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³è¯¥é—®é¢˜ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸€ä¸‹åœ¨Shiroä¸­è¯¥å¦‚ä½•åšå§ã€‚<br>
1ã€è‡ªå®šä¹‰SessionManagerç»§æ‰¿DefaultWebSessionManager</p>
<pre><code class="language-Java">/**
 * è‡ªå®šä¹‰SessionManager
 */
@Slf4j
public class CustomWebSessionManager extends DefaultWebSessionManager{

    private static final String JSESSIONID=&quot;JSESSIONID&quot;;

    @Override
    public Serializable getSessionId(SessionKey key) {
        Serializable id = super.getSessionId(key);
        //å¦‚æœä»Cookieä¸­æ²¡æœ‰è·å–åˆ°SessionId,åˆ™ä»è¯·æ±‚å¤´ä¸­è·å–
        if (id == null) {
            HttpServletRequest request = (HttpServletRequest)WebUtils.getRequest(key);
            id = request.getHeader(JSESSIONID);
        }
        return id;
    }
}
</code></pre>
<p>2ã€å°†è‡ªå®šä¹‰çš„SessionManageræ”¾å…¥å®¹å™¨ä¸­<br>
3ã€è®¾ç½®SecurityManagerçš„SessionManagerä¸ºè‡ªå®šä¹‰çš„SessionManager</p>
<pre><code class="language-Java">/**
 * Shiro é…ç½®
 */
@Configuration
public class ShiroConfig {

    /**
     * é…ç½®ShiroFilter
     * @param securityManager æ³¨å…¥SecurityManager
     * @return ShiroFilterFactoryBean
     */
    @Bean(name = &quot;shiroFilter&quot;)
    public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager) {
        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        Map&lt;String, String&gt; filterChainDefinitionMap = new LinkedHashMap&lt;&gt;();
        filterChainDefinitionMap.put(&quot;/auth/login&quot;, &quot;anon&quot;);
        filterChainDefinitionMap.put(&quot;/openapi/**&quot;, &quot;anon&quot;);
        filterChainDefinitionMap.put(&quot;/**&quot;, &quot;authc&quot;);
        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);
        return shiroFilterFactoryBean;
    }

    /**
     * é…ç½®SecurityManager
     * @param customRealm æ³¨å…¥è‡ªå®šä¹‰Realm
     * @return SecurityManager
     */
    @Bean
    public SecurityManager securityManager(CustomRealm customRealm, SessionManager sessionManager) {
        DefaultWebSecurityManager defaultSecurityManager = new DefaultWebSecurityManager();
        defaultSecurityManager.setSessionManager(sessionManager);
        defaultSecurityManager.setRealm(customRealm);
        return defaultSecurityManager;
    }

    /**
     * é…ç½®è‡ªå®šä¹‰SessionManager
     * @return
     */
    @Bean(&quot;sessionManager&quot;)
    public CustomWebSessionManager customWebSessionManager(){
        return new CustomWebSessionManager();
    }

    /**
     * é…ç½®è‡ªå®šä¹‰çš„Realm
     * @return CustomRealm
     */
    @Bean
    public CustomRealm customRealm() {
        CustomRealm customRealm = new CustomRealm();
        return customRealm;
    }
}
</code></pre>
<p>4ã€å®¢æˆ·ç«¯ç™»é™†æˆåŠŸåå°†sessionIdä¿å­˜èµ·æ¥ï¼Œæ¯æ¬¡è¯·æ±‚çš„æ—¶å€™å¸¦ä¸Šè¯¥è¯·æ±‚å¤´</p>
<h2 id="äºŒ-åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¦‚ä½•æ¥ç»´æŠ¤sessionçš„å‘¢">äºŒã€åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå¦‚ä½•æ¥ç»´æŠ¤Sessionçš„å‘¢ï¼Ÿ</h2>
<p>é‚£ä¹ˆè¿™é‡Œå°±æ˜¯å¦‚ä½•ç»Ÿä¸€ç»´æŠ¤Sessionçš„é—®é¢˜äº†ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†Sessionä¿å­˜åœ¨ç¼“å­˜ä¸­é—´ä»¶é‡Œï¼Œä¾‹å¦‚Redisï¼Œè¿™æ ·å³ä¿è¯æ€§èƒ½ï¼Œåˆå®ç°åŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä½“éªŒä¸€ä¸‹å§ï¼Ÿ<br>
1ã€è¿æ¥Redisä»¥åŠç¼–å†™RedisUtilï¼ˆè¯¥éƒ¨åˆ†ä»æ˜¯é‡‡ç”¨MAPè¿›è¡Œå¤„ç†ï¼Œå¾…åé¢å’ŒRedisç»§æ‰¿æ—¶ä¿®æ”¹è¿™é‡Œï¼‰</p>
<pre><code class="language-Java">/**
 * Rediså·¥å…·ç±»
 */
public class RedisUtil {
    static Map&lt;String,Object&gt; SESSION_ID_CACHE=new HashMap&lt;&gt;();
    public static void set(String key,Object value){
        SESSION_ID_CACHE.put(key,value);
    }
    public static Object get(String key){
        return SESSION_ID_CACHE.get(key);
    }
    public static void del(String key){
        SESSION_ID_CACHE.remove(key);
    }
    public static Collection values(){
        return SESSION_ID_CACHE.values();
    }
}
</code></pre>
<p>2ã€ç¼–å†™è‡ªå®šä¹‰SessionDao ç»§æ‰¿EnterpriseCacheSessionDAO é‡å†™è¯»å–Sessionçš„æ–¹æ³•</p>
<pre><code class="language-Java">/**
 * è‡ªå®šä¹‰SessionDAOä»Redisä¸­è¯»å–Session
 */
public class CustomSessionDAO extends EnterpriseCacheSessionDAO {
    @Override
    protected Session doReadSession(Serializable serializable) {
        return (Session) RedisUtil.get(serializable.toString());
    }
}
</code></pre>
<p>3ã€ç¼–å†™è‡ªå®šä¹‰SerssionListener ç»´æŠ¤Sessionä¸­çš„å€¼</p>
<pre><code class="language-Java">/**
 * è‡ªå®šä¹‰SerssionListener ç»´æŠ¤Sessionä¸­çš„å€¼
 */
public class CustomSessionListener implements SessionListener {
    @Override
    public void onStart(Session session) {
        RedisUtil.set(session.getId().toString(),session);
    }

    @Override
    public void onStop(Session session) {
        RedisUtil.del(session.getId().toString());
    }

    @Override
    public void onExpiration(Session session) {
        RedisUtil.del(session.getId().toString());
    }
}

</code></pre>
<p>3ã€å°†CustomSessionDAOã€CustomSerssionListeneråŠ å…¥Shiroé…ç½®ä¸­</p>
<pre><code class="language-Java">/**
 * Shiro é…ç½®
 */
@Configuration
public class ShiroConfig {

    /**
     * é…ç½®ShiroFilter
     * @param securityManager æ³¨å…¥SecurityManager
     * @return ShiroFilterFactoryBean
     */
    @Bean(name = &quot;shiroFilter&quot;)
    public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager) {
        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        Map&lt;String, String&gt; filterChainDefinitionMap = new LinkedHashMap&lt;&gt;();
        filterChainDefinitionMap.put(&quot;/auth/login&quot;, &quot;anon&quot;);
        filterChainDefinitionMap.put(&quot;/openapi/**&quot;, &quot;anon&quot;);
        filterChainDefinitionMap.put(&quot;/**&quot;, &quot;authc&quot;);
        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);
        return shiroFilterFactoryBean;
    }

    /**
     * é…ç½®SecurityManager
     * @param customRealm æ³¨å…¥è‡ªå®šä¹‰Realm
     * @return SecurityManager
     */
    @Bean
    public SecurityManager securityManager(CustomRealm customRealm, SessionManager sessionManager) {
        DefaultWebSecurityManager defaultSecurityManager = new DefaultWebSecurityManager();
        defaultSecurityManager.setSessionManager(sessionManager);
        defaultSecurityManager.setRealm(customRealm);
        return defaultSecurityManager;
    }

    /**
     * é…ç½®è‡ªå®šä¹‰SessionManager
     * @return
     */
    @Bean(&quot;sessionManager&quot;)
    public CustomWebSessionManager customWebSessionManager(SessionDAO sessionDAO){
        CustomWebSessionManager customWebSessionManager=new CustomWebSessionManager();
        customWebSessionManager.setSessionDAO(sessionDAO);
        //é…ç½®è‡ªå®šä¹‰
        List&lt;SessionListener&gt; listeners=new ArrayList&lt;&gt;();
        listeners.add(new CustomSessionListener());
        customWebSessionManager.setSessionListeners(listeners);
        return customWebSessionManager;
    }

    /**
     * é…ç½®è‡ªå®šä¹‰çš„Realm
     * @return CustomRealm
     */
    @Bean
    public CustomRealm customRealm() {
        CustomRealm customRealm = new CustomRealm();
        return customRealm;
    }

    /**
     * é…ç½®è‡ªå®šä¹‰SessionDAO
     * @return CustomSessionDAO
     */
    @Bean(&quot;sessionDAO&quot;)
    public CustomSessionDAO customSessionDao(){
        CustomSessionDAO customSessionDAO=new CustomSessionDAO();
        customSessionDAO.setSessionIdGenerator(new JavaUuidSessionIdGenerator());
        return customSessionDAO;
    }
}
</code></pre>
<h2 id="ä¸‰-åŸºäºtokençš„éªŒè¯æ–¹å¼">ä¸‰ã€åŸºäºTokençš„éªŒè¯æ–¹å¼</h2>
<p>ç°å¦‚ä»Šï¼Œå¾ˆå¤šWebåº”ç”¨çš„éªŒè¯æ–¹å¼éƒ½ä¼šé‡‡ç”¨åŸºäºtokençš„éªŒè¯æ–¹å¼ï¼Œå®é™…ä¸Šè¿™ç§æ–¹å¼å¾ˆåƒæˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„å°†SessionIdæ”¾å…¥è¯·æ±‚å¤´ä¸­ï¼Œåªæ˜¯åŸºäºtokençš„è¿™ç§æ–¹å¼ï¼Œtokençš„ä¿å­˜çš„ä¿¡æ¯å¯èƒ½æ›´å…·æœ‰æ„ä¹‰ã€‚é‚£åœ¨Shiroä¸­å¦‚ä½•æ¥å®ç°å‘¢ï¼Ÿ<br>
1ã€ç™»é™†æˆåŠŸæ—¶ï¼Œç”Ÿæˆå¯¹åº”çš„token,å¹¶ä¿å­˜åœ¨redisä¸­<br>
2ã€ç¼–å†™è®¤è¯æœåŠ¡å™¨,ç»§æ‰¿FormAuthenticationFilter,å¹¶é‡å†™onAccessDeniedï¼Œä»è¯·æ±‚å¤´ä¸­è·å–è·å–TOKENï¼Œå¹¶ä»redisä¸­è·å–tokenï¼Œå¯¹æ¯”tokenå³å¯ã€‚</p>
<h2 id="å››-ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ">å››ã€ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ</h2>
<p>ç»Ÿä¸€è®¤è¯ä¸­å¿ƒä¸»è¦æ˜¯è¿›è¡Œç»Ÿä¸€çš„èº«ä»½è®¤è¯ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š<br>
1ã€è¯·æ±‚è®¤è¯ä¸­å¿ƒæ—¶ï¼Œéœ€è¦å°†éªŒè¯åéœ€è¦è·³è½¬çš„URLä½œä¸ºè¯·æ±‚å‚æ•°ï¼›<br>
2ã€æœåŠ¡ç«¯ä¿®æ”¹ä¸ºä¸ä»…å¯ä»¥ä»Cookieå’ŒHeaderä¸­è·å–å¯¹åº”çš„tokenæˆ–è€…sessionIdï¼Œè¿˜éœ€è¦å¯ä»¥ä»è¯·æ±‚å‚æ•°é‡Œè·å–åˆ°å¯¹åº”çš„å€¼ï¼›<br>
3ã€æœåŠ¡ç«¯è®¤è¯æˆåŠŸåå°†tokenæˆ–è€…sessionIdä½œä¸ºå‚æ•°é‡å®šå‘åˆ°ç™»é™†è®¤è¯çš„å›è°ƒåœ°å€ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Shiro èº«ä»½è®¤è¯]]></title>
        <id>https://bofengsun.github.io//post/shiro-authentication</id>
        <link href="https://bofengsun.github.io//post/shiro-authentication">
        </link>
        <updated>2019-11-10T10:57:42.000Z</updated>
        <summary type="html"><![CDATA[<p>ä¸Šä¸€èŠ‚ ã€Shiro åˆä½“éªŒã€‘ä¸­æˆ‘ä»¬è®¤è¯†äº†å‡ ä¸ªShiroä¸­é‡è¦çš„æ¦‚å¿µï¼Œä»¥åŠä¸€ä¸ªQuickStartä»£ç ç¤ºä¾‹æ¼”ç¤ºäº†Shiroçš„åŸºæœ¬ä½¿ç”¨ï¼Œä¹ŸçŸ¥é“Shiroçš„å‡ ä¸ªä¸»è¦åŠŸèƒ½ï¼Œé¦–å…ˆå°±æ˜¯èº«ä»½è®¤è¯ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹Shiroæ˜¯å¦‚ä½•è¿›è¡Œèº«ä»½è®¤è¯çš„å§ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä¸Šä¸€èŠ‚ ã€Shiro åˆä½“éªŒã€‘ä¸­æˆ‘ä»¬è®¤è¯†äº†å‡ ä¸ªShiroä¸­é‡è¦çš„æ¦‚å¿µï¼Œä»¥åŠä¸€ä¸ªQuickStartä»£ç ç¤ºä¾‹æ¼”ç¤ºäº†Shiroçš„åŸºæœ¬ä½¿ç”¨ï¼Œä¹ŸçŸ¥é“Shiroçš„å‡ ä¸ªä¸»è¦åŠŸèƒ½ï¼Œé¦–å…ˆå°±æ˜¯èº«ä»½è®¤è¯ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹Shiroæ˜¯å¦‚ä½•è¿›è¡Œèº«ä»½è®¤è¯çš„å§ã€‚</p>
<!-- more -->
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬çœ‹åˆ°Shiroçš„ç™»é™†ï¼Œå½“æ—¶çš„ç”¨æˆ·ä¿¡æ¯æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½†åœ¨å®é™…é¡¹ç›®ä¸­å¹¶ä¸ä¼šè¿™æ ·ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­é‚£ä¹ˆï¼Œè¿™ç§æƒ…å†µä¸‹Shiroåˆæ˜¯æ€æ ·è¿›è¡Œèº«ä»½è®¤è¯çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯¹ä¸Šä¸€ç« çš„ä»£ç åšä¸€ä¸ªç®€å•çš„ä¿®æ”¹ï¼Œä»¥äº†è§£è®¤è¯çš„è¿‡ç¨‹ï¼š<br>
ä¾èµ–åŒ…ï¼š</p>
<pre><code class="language-XML">&lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;1.18.8&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--æ•´åˆShiro--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;
            &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;
            &lt;version&gt;1.4.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre>
<p>å‰ç½®ä»£ç ï¼š</p>
<pre><code class="language-Java">/**
 * ç»Ÿä¸€ç»´æŠ¤è¿”å›çš„æ•°æ®
 */
public enum Result{
    //é»˜è®¤è¿”å›æ•°æ®
    SUCCESS(0,&quot;è¯·æ±‚æˆåŠŸï¼&quot;),
    FAILURE(500,&quot;è¯·æ±‚å¤±è´¥ï¼&quot;),
    //è®¤è¯æˆæƒéƒ¨åˆ†
    LOGIN_FAILURE(501,&quot;ç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯ï¼&quot;),
    LOGIN_FAILURE_LOCK(501,&quot;ç”¨æˆ·è¢«é”å®š,è¯·è”ç³»ç®¡ç†å‘˜ï¼&quot;),
    LOGIN_FAILURE_RELOGIN(502,&quot;ç”¨æˆ·å·²ç»ç™»é™†,æ— é¡»å†æ¬¡ç™»é™†ï¼&quot;),
    AUTH_FAILURE(511,&quot;æ— æƒé™ï¼&quot;);

    private Integer code;
    private String msg;
    private Result(Integer code,String msg){
        this.code=code;
        this.msg=msg;
    }
    public Integer getCode() {
        return code;
    }
    public String getMsg() {
        return msg;
    }
}
/**
 * ç»Ÿä¸€è¿”å›çš„æ•°æ®ç±»å‹
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
public class ResultVo&lt;T&gt; {
    private Integer code;
    private String msg;
    private T data;
    public static &lt;T&gt; ResultVo&lt;T&gt; success(T data){
        return new ResultVo&lt;&gt;(Result.SUCCESS.getCode(),Result.SUCCESS.getMsg(),data);
    }
    public static&lt;T&gt; ResultVo&lt;T&gt; failure(Result result){
        return new ResultVo&lt;&gt;(result.getCode(),result.getMsg(),null);
    }
}
</code></pre>
<p>Shiroçš„é…ç½®ï¼šRealmã€SecurityManagerã€shiroFilter</p>
<ul>
<li>Relam:å®‰å…¨æ•°æ®</li>
<li>SecurityManagerï¼š Shiro çš„å¤§ç®¡å®¶è´Ÿè´£ç»„ä»¶åè°ƒ</li>
<li>shiroFilterï¼š Filterå¯¹å“ªäº›è¯·æ±‚è¿›è¡Œæ‹¦æˆª</li>
</ul>
<pre><code class="language-Java">/**
 * Shiro é…ç½®
 */
@Configuration
public class ShiroConfig {

    /**
     * é…ç½®ShiroFilter
     * @param securityManager æ³¨å…¥SecurityManager
     * @return ShiroFilterFactoryBean
     */
    @Bean(name = &quot;shiroFilter&quot;)
    public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager) {
        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        Map&lt;String, String&gt; filterChainDefinitionMap = new LinkedHashMap&lt;&gt;();
        filterChainDefinitionMap.put(&quot;/auth/login&quot;, &quot;anon&quot;);
        filterChainDefinitionMap.put(&quot;/**&quot;, &quot;authc&quot;);
        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);
        return shiroFilterFactoryBean;
    }

    /**
     * é…ç½®SecurityManager
     * @param customRealm æ³¨å…¥è‡ªå®šä¹‰Realm
     * @return SecurityManager
     */
    @Bean
    public SecurityManager securityManager(CustomRealm customRealm) {
        DefaultWebSecurityManager defaultSecurityManager = new DefaultWebSecurityManager();
        defaultSecurityManager.setRealm(customRealm);
        return defaultSecurityManager;
    }

    /**
     * é…ç½®è‡ªå®šä¹‰çš„Realm
     * @return CustomRealm
     */
    @Bean
    public CustomRealm customRealm() {
        CustomRealm customRealm = new CustomRealm();
        return customRealm;
    }
}
</code></pre>
<p>ç™»é™†è®¤è¯éƒ¨åˆ†çš„ä»£ç ï¼š</p>
<pre><code class="language-Java">/**
 * è®¤è¯æ§åˆ¶å™¨
 */
@RestController
@RequestMapping(&quot;/auth&quot;)
@Slf4j
public class AuthController {

    /**
     * ç™»é™†
     * @param username ç”¨æˆ·å
     * @param password å¯†ç 
     * @return ç™»é™†ç»“æœ
     */
    @PostMapping(&quot;/login&quot;)
    public ResultVo&lt;String&gt; login(@RequestParam(&quot;username&quot;) String username,@RequestParam(&quot;password&quot;) String password){
        Subject currentUser = SecurityUtils.getSubject();
        if (!currentUser.isAuthenticated()) {
            UsernamePasswordToken token = new UsernamePasswordToken(username, password);
            try {
                currentUser.login(token);
                return ResultVo.success(currentUser.getSession().getId().toString());
            }catch (LockedAccountException lae) {
                return ResultVo.failure(Result.LOGIN_FAILURE_LOCK);
            }
            catch (AuthenticationException ae) {
                return ResultVo.failure(Result.LOGIN_FAILURE);
            }
        }else {
            return ResultVo.failure(Result.LOGIN_FAILURE_RELOGIN);
        }
    }
}
</code></pre>
<p>æµç¨‹åˆ†æï¼š<br>
1ã€å…ˆé€šè¿‡SecurityUtils#getSubject()è·å–å½“å‰ç”¨æˆ·<br>
2ã€Subject#isAuthenticated()è°ƒç”¨åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ç™»é™†<br>
3ã€è‹¥æ²¡ç”¨è¿›è¡Œç™»é™†è®¤è¯ï¼Œåˆ™å°†ç”¨æˆ·çš„usernameå’Œpasswordä¸ºå°è£…UsernamePasswordToken<br>
4ã€è°ƒç”¨Subject#login(token)è¿›è¡Œç™»é™†<br>
5ã€é€šè¿‡è‡ªå®šä¹‰Realmè¿›è¡Œèº«ä»½è®¤è¯ï¼Œè‡ªå®šä¹‰Realmå¦‚æœåªæ˜¯ç”¨æ¥è¿›è¡Œèº«ä»½è®¤è¯åˆ™åªéœ€ç»§æ‰¿org.apache.shiro.realm.AuthenticatingRealmå³å¯ï¼Œå¦‚æœè¿˜éœ€è¦è¿›è¡Œé‰´æƒï¼Œåˆ™éœ€è¦ç»§æ‰¿org.apache.shiro.realm.AuthorizingRealm,è¿™é‡Œæˆ‘ä»¬å°±å…ˆç»§æ‰¿AuthenticatingRealmã€‚<br>
æŸ¥çœ‹Realmçš„å‰ç½®ä»£ç ï¼š</p>
<pre><code class="language-Java">/**
 * ç”¨æˆ·å®ä½“ä¿¡æ¯
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class User {

    /**
     * é€»è¾‘ID
     */
    private String id;
    /**
     * ç”¨æˆ·å(å”¯ä¸€)
     */
    private String username;
    /**
     * å¯†ç 
     */
    private String password;
    /**
     * çŠ¶æ€æ˜¯å¦é”å®š:1 æ˜¯ï¼›0å¦
     */
    private Integer status;
}
/**
 * ç”¨æˆ·æœåŠ¡
 */
public interface UserService {
    /**
     * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·
     * @param username ç”¨æˆ·å
     * @return User
     */
    User getByUsername(String username);
}
@Service
public class UserServiceImpl implements UserService {
    /**
     * åˆå§‹åŒ–ç”¨æˆ·æ•°æ®æº
     */
    static final Map&lt;String,User&gt; USERS = new HashMap&lt;&gt;();
    static {
        USERS.put(&quot;admin&quot;,User.builder()
                .id(&quot;1&quot;)
                .username(&quot;admin&quot;)
                .password(&quot;123456&quot;)
                .status(0)
                .build());
        USERS.put(&quot;guest&quot;,User.builder()
                .id(&quot;2&quot;)
                .username(&quot;guest&quot;)
                .password(&quot;123456&quot;)
                .status(0)
                .build());
        USERS.put(&quot;lockeduser&quot;,User.builder()
                .id(&quot;2&quot;)
                .username(&quot;lockeduser&quot;)
                .password(&quot;123456&quot;)
                .status(1)
                .build());
    }

    @Override
    public User getByUsername(String username) {
        return USERS.get(username);
    }
}
/**
 * å¸¸é‡ç±»
 */
public interface Constant {
    /**
     * ç”¨æˆ·è¢«é”å®šçŠ¶æ€
     */
    Integer USER_LOCKED=1;
}
/**
 * è‡ªå®šä¹‰Realm
 */
@Slf4j
public class CustomRealm extends AuthenticatingRealm {

    @Autowired
    private UserService userService;

    /**
     * å®ç°è¯¥æ–¹æ³•è¿›è¡Œè®¤è¯ï¼Œåœ¨è°ƒç”¨Subject#loginçš„æ—¶å€™ä¼šè¿›å…¥è¯¥æ–¹æ³•
     * @param authenticationToken ä»¤ç‰Œ
     * @return è®¤è¯çš„ä¿¡æ¯
     * @throws AuthenticationException è®¤è¯å¼‚å¸¸
     */
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        log.info(&quot;å¼€å§‹è¿›è¡Œèº«ä»½è®¤è¯ï¼&quot;);
        UsernamePasswordToken usernamePasswordToken=(UsernamePasswordToken)authenticationToken;
        String username = usernamePasswordToken.getUsername();
        User user = userService.getByUsername(username);
        if(user==null){
            log.info(&quot;ç”¨æˆ·æœªæ‰¾åˆ°ï¼&quot;);
            throw new UnknownAccountException(Result.LOGIN_FAILURE.getMsg());
        }else if (Constant.USER_LOCKED.equals(user.getStatus())){
            log.info(&quot;ç”¨æˆ·è¢«é”å®šï¼&quot;);
            throw new LockedAccountException(Result.LOGIN_FAILURE_LOCK.getMsg());
        }else {
            String principal=username;
            String credentials=user.getPassword();
            String realmName=getName();
            SimpleAuthenticationInfo simpleAuthenticationInfo=new SimpleAuthenticationInfo(principal,credentials,realmName);
            log.info(&quot;è®¤è¯æˆåŠŸï¼&quot;);
            return simpleAuthenticationInfo;
        }
    }
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Shiro åˆä½“éªŒ]]></title>
        <id>https://bofengsun.github.io//post/shiro-01</id>
        <link href="https://bofengsun.github.io//post/shiro-01">
        </link>
        <updated>2019-11-08T09:39:44.000Z</updated>
        <summary type="html"><![CDATA[<p>Shiro æ˜¯ä¸€ä¸ªJavaå®‰å…¨æ¡†æ¶ï¼Œä¸»è¦æ˜¯è¿›è¡Œèº«ä»½è®¤è¯ï¼Œæƒé™è®¤è¯ï¼Œå¯†ç åŠ å¯†ï¼Œä¼šè¯ç®¡ç†çš„ä¸€å¥—æ¡†æ¶ï¼Œä¸‹é¢è®©æˆ‘ä»¬ä¸€èµ·æ¥è®¤è¯†ä¸€ä¸‹Shiroå§!</p>
]]></summary>
        <content type="html"><![CDATA[<p>Shiro æ˜¯ä¸€ä¸ªJavaå®‰å…¨æ¡†æ¶ï¼Œä¸»è¦æ˜¯è¿›è¡Œèº«ä»½è®¤è¯ï¼Œæƒé™è®¤è¯ï¼Œå¯†ç åŠ å¯†ï¼Œä¼šè¯ç®¡ç†çš„ä¸€å¥—æ¡†æ¶ï¼Œä¸‹é¢è®©æˆ‘ä»¬ä¸€èµ·æ¥è®¤è¯†ä¸€ä¸‹Shiroå§!</p>
<!-- more -->
<h2 id="1-è®¤è¯†shiroçš„åŠŸèƒ½">1ã€è®¤è¯†Shiroçš„åŠŸèƒ½</h2>
<p>çœ‹å›¾è¯´è¯ï¼Œä¸‹å›¾ä¸­æ˜¯Shiroå®˜ç½‘ç»™å‡ºçš„æè¿°ï¼Œå¾ˆæ˜æ˜¾ä¸»è¦åŒ…æ‹¬å››ç‚¹ï¼š</p>
<ul>
<li>Authentication(èº«ä»½è®¤è¯)</li>
<li>Authorization(æƒé™è®¤è¯)</li>
<li>Session Management(ä¼šè¯ç®¡ç†)</li>
<li>Cryptography(å¯†ç å­¦)<br>
<img src="https://bofengsun.github.io//post-images/1573123546063.png" alt="ShiroåŠŸèƒ½"></li>
</ul>
<h2 id="2-å…³é”®æ¦‚å¿µè®¤è¯†">2ã€å…³é”®æ¦‚å¿µè®¤è¯†</h2>
<ul>
<li>Subject (org.apache.shiro.subject.Subject) ä¸»ä½“<br>
æŒ‡æ­£åœ¨è®¿é—®çš„ä¸»ä½“ï¼Œé€šå¸¸æŒ‡å½“å‰ç”¨æˆ·ï¼Œäº¦å¯æŒ‡çˆ¬è™«ã€å®šæ—¶ä»»åŠ¡ç­‰ã€‚</li>
<li>SecurityManager (org.apache.shiro.mgt.SecurityManager) å®‰å…¨ç®¡ç†å™¨<br>
å®‰å…¨ç®¡ç†å™¨ï¼Œæ˜¯Shiroçš„æ ¸å¿ƒï¼Œç®¡ç†ç€æ‰€æœ‰çš„Subjectï¼Œè´Ÿè´£ä¸Shiroçš„å…¶ä»–ç»„ä»¶è¿›è¡Œäº¤äº’ï¼Œç±»ä¼¼ä¸SpringMvc ä¸­çš„DispatcherServletã€‚</li>
<li>Realms å®‰å…¨æ•°æ®<br>
ä¸»è¦æ˜¯å‚¨å­˜Shiroçš„å®‰å…¨æ•°æ®ï¼ˆç”¨æˆ·ã€è§’è‰²ã€æƒé™ç­‰ï¼‰ï¼ŒSecurityManageréªŒè¯ç”¨æˆ·æ˜¯å¦ç™»é™†ã€æ˜¯å¦æ‹¥æœ‰æƒé™ç­‰éœ€è¦ä»å…¶ä¸­è·å–æ•°æ®ã€‚<br>
<img src="https://bofengsun.github.io//post-images/1573126718187.png" alt=""></li>
</ul>
<h2 id="3-åˆä½“éªŒ">3ã€åˆä½“éªŒ</h2>
<pre><code class="language-Java">//git clone https://github.com/apache/shiro.git ä¸‹è½½Shiroæºç åŒ…æ‹¬è¯¥ä»£ç ã€‚

public class Quickstart {

    private static final transient Logger log = LoggerFactory.getLogger(Quickstart.class);


    public static void main(String[] args) {

        //ç”¨æ¥ä»é…ç½®æ–‡ä»¶åˆå§‹åŒ–Shiroç¯å¢ƒï¼Œä¸€èˆ¬ä¸ä¼šç”¨
        Factory&lt;SecurityManager&gt; factory = new IniSecurityManagerFactory(&quot;classpath:shiro.ini&quot;);
        SecurityManager securityManager = factory.getInstance();
        SecurityUtils.setSecurityManager(securityManager);
        //è·å–å½“å‰ç”¨æˆ·,ä»è¿™ä»¥åçš„ä»£ç éƒ½æ¯”è¾ƒé‡è¦
        Subject currentUser = SecurityUtils.getSubject();
        //è·å–Session
        Session session = currentUser.getSession();
        session.setAttribute(&quot;someKey&quot;, &quot;aValue&quot;);
        String value = (String) session.getAttribute(&quot;someKey&quot;);
        if (value.equals(&quot;aValue&quot;)) {
            log.info(&quot;Retrieved the correct value! [&quot; + value + &quot;]&quot;);
        }

        // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç»è¿‡èº«ä»½è®¤è¯ï¼Œå¦‚æœæ²¡ç”¨åˆ™è¿›è¡Œèº«ä»½è®¤è¯
        if (!currentUser.isAuthenticated()) {
            //é€šè¿‡ç”¨æˆ·åå¯†ç è¿›è¡Œç™»é™†
            UsernamePasswordToken token = new UsernamePasswordToken(&quot;lonestarr&quot;, &quot;vespa&quot;);   //è®¾ç½®è®°ä½æˆ‘
            token.setRememberMe(true);
            try {
                //è¿›è¡Œç™»é™†
                currentUser.login(token);
            } catch (UnknownAccountException uae) {//ç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸
                log.info(&quot;There is no user with username of &quot; + token.getPrincipal());
            } catch (IncorrectCredentialsException ice) {//å¯†ç ä¸æ­£ç¡®å¼‚å¸¸
                log.info(&quot;Password for account &quot; + token.getPrincipal() + &quot; was incorrect!&quot;);
            } catch (LockedAccountException lae) {//ç”¨æˆ·è¢«é”å®šå¼‚å¸¸
                log.info(&quot;The account for username &quot; + token.getPrincipal() + &quot; is locked.  &quot; +
                        &quot;Please contact your administrator to unlock it.&quot;);
            }
            // ... catch more exceptions here (maybe custom ones specific to your application?
            catch (AuthenticationException ae) {//è®¤è¯å¼‚å¸¸ï¼ŒæŸ¥çœ‹å…¶å­ç±»å‘ç°Shiroæä¾›çš„è®¤è¯å¼‚å¸¸
                //unexpected condition?  error?
            }
        }

        log.info(&quot;User [&quot; + currentUser.getPrincipal() + &quot;] logged in successfully.&quot;);

        // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è§’è‰²
        if (currentUser.hasRole(&quot;schwartz&quot;)) {
            log.info(&quot;May the Schwartz be with you!&quot;);
        } else {
            log.info(&quot;Hello, mere mortal.&quot;);
        }

        //åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æƒé™
        //åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰winnebago:drive:eagle5æƒé™
        //winnebago ç±»å‹ï¼Œdriver è¡Œä¸ºï¼Œeagle5å¯¹è±¡
        //å¦‚ å½“å‰ç”¨æˆ·æ‹¥æœ‰å¯¹å¼ ä¸‰ï¼ˆå¯¹è±¡ï¼‰è¿™ä¸ªç”¨æˆ·ï¼ˆç±»å‹ï¼‰çš„åˆ é™¤è¡Œä¸º
        if (currentUser.isPermitted(&quot;winnebago:drive:eagle5&quot;)) {
            log.info(&quot;You are permitted to 'drive' the winnebago with license plate (id) 'eagle5'.  &quot; +
                    &quot;Here are the keys - have fun!&quot;);
        } else {
            log.info(&quot;Sorry, you aren't allowed to drive the 'eagle5' winnebago!&quot;);
        }

        //ç”¨æˆ·é€€å‡ºç™»é™†
        currentUser.logout();

        System.exit(0);
    }
}
</code></pre>
]]></content>
    </entry>
</feed>